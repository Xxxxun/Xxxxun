## 使用OpenVPN连接服务器debug

在内地连接服务器需要使用vpn+GlobalProtect+OpenVPN连接服务器，并且存在诸多bug，特以此篇博客记录。BTW,新年快乐！
---

#### 尝试修改OpenVPN .ovpn file
```powershell
setenv FORWARD_COMPATIBLE 1
client
server-poll-timeout 4
nobind

# 尝试指定使用tcp协议，避免防火墙
# 注释掉所有其他utp协议

# remote openvpn.cse.cuhk.edu.hk 1194 udp
# remote openvpn.cse.cuhk.edu.hk 1194 udp
remote openvpn.cse.cuhk.edu.hk 443 tcp
# remote openvpn.cse.cuhk.edu.hk 1194 udp
# remote openvpn.cse.cuhk.edu.hk 1194 udp
# remote openvpn.cse.cuhk.edu.hk 1194 udp
# remote openvpn.cse.cuhk.edu.hk 1194 udp
# remote openvpn.cse.cuhk.edu.hk 1194 udp

# 拒收指令
# 背景：通常，学校的 OpenVPN 服务器配置里有一条指令叫 redirect-gateway（重定向网关）。它的作用是强制把你电脑的所有流量（包括你访问百度、聊微信、看视频的流量）都吸进 VPN 隧道里。
# 尝试加上 route-nopull 无视服务器发来的“接管一切”的命令。电脑依然通过原本的 WiFi 上网，网络不会断。
route-nopull

# route [IP] [掩码] vpn_gateway —— “手动指路”
# 强制指向内网的流量使用vpn
route 137.189.0.0 255.255.0.0 vpn_gateway
route 172.16.0.0 255.240.0.0 vpn_gateway

# 修改结束
dev tun
dev-type tun
ns-cert-type server
setenv opt tls-version-min 1.0 or-highest
reneg-sec 604800
sndbuf 0
rcvbuf 0
auth-user-pass
# NOTE: LZO commands are pushed by the Access Server at connect time.
# NOTE: The below line doesn't disable LZO.
comp-lzo no
verb 3
setenv PUSH_PEER_INFO

<ca>
```

#### 删除usr/.ssh/known_hosts
意外解决问题
参考了这篇 [ServerFault 讨论](https://serverfault.com/questions/1015547/what-causes-ssh-error-kex-exchange-identification-connection-closed-by-remote)。

##### 原理见Gemini回复：
这个操作之所以能解决问题，是因为你的 **SSH 客户端（电脑）** 和 **服务器（学校）** 之间的“信任关系”因为之前的代理干扰出现了错乱。

简单来说，`known_hosts` 就像是 SSH 的 **“好友通讯录”** 或 **“人脸识别数据库”**。

以下是详细的原理拆解：

###### 1. `known_hosts` 的作用：防“掉包”机制

当你第一次连接某个 SSH 服务器（比如 `csegw`）时，服务器会把它的 **公钥指纹（Fingerprint）** 发给你的电脑。

* 你的电脑会弹窗问：“这个指纹是 `xx:xx:xx...`，你信任它吗？”
* 当你输入 `yes` 后，SSH 就会把这个指纹、服务器的 IP 和端口记录在 `~/.ssh/known_hosts` 文件里。

**以后每次连接：**
SSH 都会先去查这个文件：“上次连 `csegw` 时它是长这样的，现在连的这个服务器还是同一个指纹吗？”

* **如果一致：** 正常连接。
* **如果不一致：** SSH 会立刻报警（报错 `Host key verification failed`），并掐断连接。这是为了防止 **中间人攻击（Man-in-the-Middle Attack）**，怕你连到了黑客伪造的假服务器。

###### 2. 为什么在你的情况里它会报错？

在你的故障排查过程中，发生了 **网络路径的剧烈变化**：

* **阶段 A（走代理 Clash）**：
当你之前配置错误时，SSH 实际上是连给了 `127.0.0.1:7897`（Clash 代理）。虽然连接失败了，但在某些情况下，SSH 可能记录下了一个与“代理环境”相关的错误指纹，或者记录了“这个主机必须通过某种特定方式连接”。
* **阶段 B（走 VPN 直连）**：
当你通过修改 PAC 或 Clash 规则修好了路由，SSH 终于绕过代理，直接连到了真实的学校服务器（通过 OpenVPN）。
* **冲突爆发**：
这时候，SSH 发现：“不对啊！我现在连到的这个真实服务器提供的指纹，和我 `known_hosts` 里的记录（之前乱七八糟环境下记录的，或者是旧的记录）对不上！”
于是 SSH 为了安全，直接拒绝了连接。

###### 3. 删除操作做了什么？

当你删除了 `.ssh/known_hosts`（或者删除了里面对应的行）：

1. **失忆**：你的电脑“忘掉了”之前记录的所有服务器指纹。
2. **重置**：当你再次发起连接时，SSH 把学校服务器当成一个 **“新朋友”**。
3. **重建信任**：它重新获取了真实服务器的指纹，并建立了新的、正确的记录。

###### 总结

这就好比你有一个朋友整容了（或者你之前认错人了）。
如果不把脑海里“旧照片”撕掉，你永远觉得眼前这个人是假的。删除 `known_hosts` 就是撕掉旧照片，重新认识真正的服务器。

**注意：** 在日常使用中，如果网络环境没变，SSH 突然报错指纹不匹配，千万不要急着删文件，那可能是真的遭到黑客攻击了。但在你这种刚调完 VPN 和代理的场景下，这属于常规操作。
